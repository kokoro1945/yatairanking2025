# Supabase 連携手順（フロントエンド送信）

生駒祭屋台ランキングの来場者回答を Google フォームへ送信すると同時に、  
フロントエンドから Supabase `yatai_votes` テーブルへ直接保存するための手順をまとめます。

---

## 1. Supabase プロジェクトの準備

1. [Supabase](https://supabase.com/) にログインし、新規プロジェクトを作成します。  
   - プロジェクト名・パスワードを記入し、リージョンは近いものを選択してください。
2. プロジェクトが作成されたら、`Project Settings › API` で以下を控えます。
   - `URL`（例：`https://xxxxx.supabase.co`）
   - `service_role` キー（**GAS からの Insert 用。外部に公開しないこと**）
3. `SQL Editor` で下記のテーブルを作成します。UI からテーブルを追加しても構いません。  
   リポジトリには同内容のスクリプト `sql/create_yatai_votes.sql` も用意しています。

```sql
create table if not exists public.yatai_votes (
  id bigint generated by default as identity primary key,
  booth_id text not null,
  taste integer not null check (taste between 1 and 5),
  service integer not null check (service between 1 and 5),
  visual integer not null check (visual between 1 and 5),
  amount integer not null check (amount between 1 and 5),
  comment text,
  timestamp timestamptz not null default timezone('utc', now())
);
```

4. Row Level Security (RLS) を有効にします。
   - `Table Editor › yatai_votes › Security` で `Enable RLS` をオン。
   - フロントエンド（`anon` ロール）からの挿入を許可するポリシー例：
     ```sql
     create policy if not exists "allow inserts from anon"
     on public.yatai_votes
     for insert
     to anon
     with check (true);
     ```
   - テーブルに不要な操作を許可しないよう、`select` などは別途必要に応じてポリシーを追加してください。

---

## 2. フロントエンドの設定

Google フォームへの送信ロジックに加えて、`main.js` から Supabase REST API へ直接 POST しています。  
環境に合わせて次の定数を更新してください。

```javascript
// main.js 冒頭付近
const SUPABASE_URL = 'https://xxxxx.supabase.co';
const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
const SUPABASE_TABLE = 'yatai_votes';
```

- `SUPABASE_URL` は Project Settings › API に表示される `Project URL`。
- `SUPABASE_KEY` は同画面の `anon public` API key を利用してください（service_role をフロントに埋め込まない）。
- `SUPABASE_TABLE` を変更したい場合は REST エンドポイントに合わせて書き換えます。

送信時の流れは以下の通りです。

1. Google フォームへ `no-cors` POST（既存仕様）。
2. 並行して Supabase REST API へ JSON で INSERT。
3. Supabase 連携に失敗した場合はブラウザのアラートで警告します（フォーム送信は完了します）。

---

## 3. 動作確認

1. ブラウザでローカル環境（もしくはデプロイ環境）を開き、テスト回答を送信します。
2. ブラウザコンソールでエラーが出ていないか確認します。
3. Supabase の `Table Editor` で `yatai_votes` に新しいレコードが追加されていることを確認します。

---

## 4. 運用・セキュリティのポイント

- フロントエンドに埋め込むキーは `anon` キーのみとし、`service_role` キーを公開しないでください。
- RLS ポリシーは必要最小限にし、不要な操作（update/delete/select）を許可しないよう注意します。
- Supabase への Insert が連続で失敗する場合に備えて、ログ監視やリトライ導線を検討してください。
- フォームの設問名が変更された場合は `main.js` 内の `QUESTION_TITLES` と Supabase 連携処理も合わせて更新してください。

---

## 5. 参考リンク

- [Supabase Docs – REST API](https://supabase.com/docs/reference/javascript/supabase-client)
- [Supabase Docs – Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Fetch API – MDN](https://developer.mozilla.org/ja/docs/Web/API/Fetch_API)

このドキュメントを更新した際はコミットメッセージや README からリンクすると運用メンバーが追跡しやすくなります。
