# 屋台評価フォーム 仕様書

生駒祭来場者向け評価フォームの実装構成と連携仕様をまとめる。

---

## 1. システム概要

- 利用者は QR コードまたは直接アクセスで評価ページに遷移。
- URL クエリ `?booth=***` が存在する場合は屋台番号を自動入力し編集不可。
- フロントエンドのみで構成され、Google フォームへ直接 POST。
- 同時に Supabase REST API へ投票内容を保存し、ランキング集計に利用。
- GAS や独自バックエンドは使用しない。

---

## 2. 主要ファイル

| ファイル | 役割 |
|----------|------|
| `index.html` | UI レイアウト、フォーム要素定義 |
| `style.css` | 近大カラーを基調にしたスタイルとレスポンシブ定義 |
| `main.js` | 屋台番号ゲート、バリデーション、送信処理、Supabase 連携 |
| `sql/create_yatai_votes.sql` | Supabase テーブルおよび RLS ポリシー作成スクリプト |
| `docs/supabase_gas_setup.md` | Supabase 連携手順（フロントエンド版） |
| `docs/仕様書.md` | 本ドキュメント |

---

## 3. フロントエンド挙動

### 3.1 屋台番号ゲート

1. ページロード時に `booth` クエリを確認。値が妥当ならフォームへ進む。
2. クエリが無い場合は入力ゲートを表示し、3 桁入力後「この屋台を評価する」でフォームへ。
3. ローカルストレージ `voted_booths` に同一番号があれば再投票不可。

### 3.2 評価フォーム

- 星評価（Radio）4 項目と任意コメントを用意。
- 必須項目が揃うまで送信ボタンを無効化し、未入力項目をラベル表示。
- スター選択時には視覚的なハイライトを適用。

### 3.3 送信フロー

1. `handleFormSubmit` で入力チェックを実施。
2. `FormData` を作り、Google フォームへ `no-cors` POST。
3. 同時に Supabase へ JSON で POST（`sendToSupabase`）。
4. `Promise.allSettled` で両方の結果を確認。
   - Google フォームが失敗: アラート表示、ボタン再有効化。
   - Supabase が失敗: アラート表示、ボタン再有効化、`voted_booths` へ保存しない。
   - 両方成功: ローカルストレージへ屋台番号を追加しサンクス画面へ。
5. Supabase 成功時／失敗時に明示的な `window.alert` を表示。

### 3.4 デバッグログ

- 送信前後で `console.debug('[submit] ...')` を出力し、payload や結果を確認可能。
- Supabase エラー時は `console.error` にレスポンス本文を出力。

---

## 4. Supabase 連携仕様

- `main.js` 冒頭に以下の定数を定義。

  ```javascript
  const SUPABASE_URL = 'https://xxxxx.supabase.co';
  const SUPABASE_KEY = 'YOUR_ANON_KEY';
  const SUPABASE_TABLE = 'yatai_votes';
  ```

- `SUPABASE_KEY` は `anon public` キーを使用（`service_role` を埋め込まない）。
- `sql/create_yatai_votes.sql` を実行してテーブルと `anon` ロール向けの Insert ポリシーを作成。
- 送信 payload 例：

  ```json
  {
    "booth_id": "001",
    "taste": 5,
    "service": 4,
    "visual": 5,
    "amount": 4,
    "comment": "美味しかったです！",
    "timestamp": "2025-11-03T03:24:15.123Z"
  }
  ```

- Supabase 失敗時はフォーム送信のみ完了し、ローカルストレージ登録やサンクス画面への遷移を抑止。

---

## 5. ローカルストレージ仕様

- キー: `voted_booths`
- 値: `["001", "002", ...]`
- Supabase 連携と Google フォーム送信が成功した場合のみ追加。
- 読み込み時に JSON 変換できなければ空配列として扱う。

---

## 6. UI / UX ポイント

- 近大グリーンを基調にしたグラデーション背景とカードデザイン。
- 質問タイトルは角丸ラベル化し視認性向上。
- 屋台番号変更ボタン、アラートメッセージ、thanks 画面など状態ごとの表示を整理。
- エラー・警告メッセージは色分けし、音声読み上げ対応の `aria-live` 属性を付与。

---

## 7. 今後の運用メモ

- Supabase 側で RLS ポリシーにより `anon` ロールが insert できる状態を維持する。
- 評価項目追加やフォーム文言変更の際は `main.js` の `QUESTION_TITLES`、`buildSupabasePayload` を更新。
- API キー漏洩防止のため、公開リポジトリでは環境ごとのキーを別途注入する構成に変更検討。
- ログの継続監視や失敗時のユーザーサポートフローを整備。

---

作成者: Coding Agent (Codex CLI)  
更新日: 2025-XX-XX
